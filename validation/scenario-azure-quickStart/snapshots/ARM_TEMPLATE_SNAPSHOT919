{
  "structure": "filesystem",
  "error": null,
  "reference": "master",
  "contentType": "json",
  "source": "gitConnectorAzureQuickStart",
  "paths": [
    "/quickstarts/microsoft.apimanagement/api-management-create-with-internal-vnet-application-gateway/azuredeploy.json",
    "/quickstarts/microsoft.apimanagement/api-management-create-with-internal-vnet-application-gateway/azuredeploy.parameters.json"
  ],
  "timestamp": 1642962902761,
  "queryuser": null,
  "checksum": "99914b932bd37a50b983c5e7c90ae93b",
  "node": {
    "masterSnapshotId": "ARM_TEMPLATE_SNAPSHOT",
    "type": "arm",
    "collection": "armtemplate",
    "paths": [
      "/quickstarts/microsoft.apimanagement/api-management-create-with-internal-vnet-application-gateway/azuredeploy.json",
      "/quickstarts/microsoft.apimanagement/api-management-create-with-internal-vnet-application-gateway/azuredeploy.parameters.json"
    ],
    "snapshotId": "ARM_TEMPLATE_SNAPSHOT919",
    "status": "active",
    "validate": true,
    "resourceTypes": [
      "microsoft.network/publicipaddresses",
      "microsoft.network/virtualnetworks",
      "microsoft.network/privatednszones",
      "microsoft.apimanagement/service",
      "microsoft.network/applicationgateways",
      "microsoft.insights/components",
      "microsoft.insights/diagnosticsettings"
    ]
  },
  "snapshotId": "ARM_TEMPLATE_SNAPSHOT919",
  "collection": "armtemplate",
  "json": {
    "contentVersion": "1.0.0.0",
    "parameters": {
      "base-name": {
        "type": "string",
        "metadata": {
          "description": "This will be used to derive names for all of your resources"
        },
        "value": "GEN-UNIQUE"
      },
      "log-analytics-workspace-id": {
        "type": "string",
        "metadata": {
          "description": "The resource ID for an existing Log Analytics workspace"
        },
        "value": "GET-PREREQ-logAnalyticsWorkspaceId"
      },
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "metadata": {
          "description": "Location in which resources will be created"
        }
      },
      "apim-sku": {
        "type": "string",
        "defaultValue": "Developer",
        "allowedValues": [
          "Developer",
          "Premium"
        ],
        "metadata": {
          "description": "The edition of Azure API Management to use. This must be an edition that supports VNET Integration. This selection can have a significant impact on consumption cost and 'Developer' is recommended for non-production use."
        }
      },
      "apim-capacity": {
        "type": "int",
        "defaultValue": 1,
        "metadata": {
          "description": "The number of Azure API Management capacity units to provision. For Developer edition, this must equal 1."
        }
      },
      "app-gateway-capacity": {
        "type": "int",
        "defaultValue": 1,
        "metadata": {
          "description": "The number of Azure Application Gateway capacity units to provision. This setting has a direct impact on consumption cost and is recommended to be left at the default value of 1"
        }
      },
      "vnet-address-prefix": {
        "type": "string",
        "defaultValue": "10.0.0.0/16",
        "metadata": {
          "description": "The address space (in CIDR notation) to use for the VNET to be deployed in this solution. If integrating with other networked components, there should be no overlap in address space."
        }
      },
      "app-gateway-subnet-prefix": {
        "type": "string",
        "defaultValue": "10.0.0.0/24",
        "metadata": {
          "description": "The address space (in CIDR notation) to use for the subnet to be used by Azure Application Gateway. Must be contained in the VNET address space."
        }
      },
      "apim-subnet-prefix": {
        "type": "string",
        "defaultValue": "10.0.1.0/24",
        "metadata": {
          "description": "The address space (in CIDR notation) to use for the subnet to be used by Azure API Management. Must be contained in the VNET address space."
        }
      },
      "apim-publisher-name": {
        "type": "string",
        "defaultValue": "Contoso",
        "metadata": {
          "description": "Descriptive name for publisher to be used in the portal"
        }
      },
      "apim-publisher-email": {
        "type": "string",
        "defaultValue": "api@contoso.com",
        "metadata": {
          "description": "Email adddress associated with publisher"
        }
      }
    },
    "variables": {
      "app-insights-name": "GEN-UNIQUE-ai",
      "vnet-name": "GEN-UNIQUE-vnet",
      "apim-name": "GEN-UNIQUE-apim",
      "public-ip-name": "GEN-UNIQUE-pip",
      "app-gateway-name": "GEN-UNIQUE-agw",
      "vnet-dns-link-name": "GEN-UNIQUE-vnet-dns-link"
    },
    "resources": [
      {
        "type": "Microsoft.ApiManagement/service",
        "apiVersion": "2020-12-01",
        "name": "GEN-UNIQUE-apim",
        "location": "[resourceGroup().location]",
        "sku": {
          "name": "Developer",
          "capacity": 1
        },
        "identity": {
          "type": "SystemAssigned"
        },
        "dependsOn": [
          "Microsoft.Network/virtualNetworks/GEN-UNIQUE-vnet"
        ],
        "resources": [
          {
            "type": "gateways",
            "apiVersion": "2020-12-01",
            "name": "my-gateway",
            "dependsOn": [
              "Microsoft.ApiManagement/service/GEN-UNIQUE-apim"
            ],
            "properties": {
              "locationData": {
                "name": "My internal location"
              },
              "description": "Self hosted gateway bringing API Management to the edge"
            }
          },
          {
            "type": "loggers",
            "apiVersion": "2020-12-01",
            "name": "AppInsightsLogger",
            "dependsOn": [
              "Microsoft.ApiManagement/service/GEN-UNIQUE-apim"
            ],
            "properties": {
              "loggerType": "applicationInsights",
              "resourceId": "Microsoft.Insights/components/GEN-UNIQUE-ai",
              "credentials": {
                "instrumentationKey": "[reference(variables('app-insights-name')).InstrumentationKey]"
              }
            }
          },
          {
            "type": "diagnostics",
            "apiVersion": "2020-12-01",
            "name": "applicationinsights",
            "dependsOn": [
              "Microsoft.ApiManagement/service/GEN-UNIQUE-apim",
              "Microsoft.ApiManagement/service/loggers/GEN-UNIQUE-apim/AppInsightsLogger"
            ],
            "properties": {
              "alwaysLog": "allErrors",
              "httpCorrelationProtocol": "Legacy",
              "verbosity": "information",
              "logClientIp": true,
              "loggerId": "Microsoft.ApiManagement/service/loggers//GEN-UNIQUE-apim/AppInsightsLogger",
              "sampling": {
                "samplingType": "fixed",
                "percentage": 100
              },
              "frontend": {
                "request": {
                  "body": {
                    "bytes": 0
                  }
                },
                "response": {
                  "body": {
                    "bytes": 0
                  }
                }
              },
              "backend": {
                "request": {
                  "body": {
                    "bytes": 0
                  }
                },
                "response": {
                  "body": {
                    "bytes": 0
                  }
                }
              }
            }
          }
        ],
        "properties": {
          "publisherName": "Contoso",
          "publisherEmail": "api@contoso.com",
          "virtualNetworkType": "Internal",
          "virtualNetworkConfiguration": {
            "subnetResourceId": "Microsoft.Network/virtualNetworks/subnets/GEN-UNIQUE-vnet/apimSubnet"
          }
        }
      },
      {
        "scope": "[format('Microsoft.ApiManagement/service/{0}', variables('apim-name'))]",
        "type": "Microsoft.Insights/diagnosticSettings",
        "apiVersion": "2017-05-01-preview",
        "name": "logToAnalytics",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "Microsoft.ApiManagement/service/GEN-UNIQUE-apim"
        ],
        "properties": {
          "workspaceId": "GET-PREREQ-logAnalyticsWorkspaceId",
          "logs": [
            {
              "category": "GatewayLogs",
              "enabled": true
            }
          ],
          "metrics": [
            {
              "category": "AllMetrics",
              "enabled": true
            }
          ]
        }
      },
      {
        "type": "Microsoft.Network/applicationGateways",
        "apiVersion": "2020-11-01",
        "name": "GEN-UNIQUE-agw",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "Microsoft.Insights/components/GEN-UNIQUE-ai",
          "Microsoft.Network/publicIPAddresses/GEN-UNIQUE-pip",
          "Microsoft.Network/virtualNetworks/GEN-UNIQUE-vnet"
        ],
        "properties": {
          "sku": {
            "name": "WAF_v2",
            "tier": "WAF_v2",
            "capacity": 1
          },
          "gatewayIPConfigurations": [
            {
              "name": "appGatewayIpConfig",
              "properties": {
                "subnet": {
                  "id": "Microsoft.Network/virtualNetworks/subnets/GEN-UNIQUE-vnet/appGatewaySubnet"
                }
              }
            }
          ],
          "frontendIPConfigurations": [
            {
              "name": "appGwPublicFrontendIp",
              "properties": {
                "privateIPAllocationMethod": "Dynamic",
                "publicIPAddress": {
                  "id": "Microsoft.Network/publicIPAddresses/GEN-UNIQUE-pip"
                }
              }
            }
          ],
          "frontendPorts": [
            {
              "name": "port_80",
              "properties": {
                "port": 80
              }
            }
          ],
          "backendAddressPools": [
            {
              "name": "gatewayBackEnd",
              "properties": {
                "backendAddresses": [
                  {
                    "fqdn": "GEN-UNIQUE-apim.azure-api.net"
                  }
                ]
              }
            }
          ],
          "backendHttpSettingsCollection": [
            {
              "name": "apim-gateway-https-setting",
              "properties": {
                "port": 443,
                "protocol": "Https",
                "cookieBasedAffinity": "Disabled",
                "hostName": "GEN-UNIQUE-apim.azure-api.net",
                "pickHostNameFromBackendAddress": false,
                "requestTimeout": 20,
                "probe": {
                  "id": "Microsoft.Network/applicationGateways/probes/GEN-UNIQUE-agw/apim-gateway-probe"
                }
              }
            }
          ],
          "httpListeners": [
            {
              "name": "apim-listener",
              "properties": {
                "frontendIPConfiguration": {
                  "id": "Microsoft.Network/applicationGateways/frontEndIPConfigurations/GEN-UNIQUE-agw/appGwPublicFrontendIp"
                },
                "frontendPort": {
                  "id": "Microsoft.Network/applicationGateways/frontEndPorts/GEN-UNIQUE-agw/port_80"
                },
                "protocol": "Http",
                "requireServerNameIndication": false
              }
            }
          ],
          "requestRoutingRules": [
            {
              "name": "apim-routing-rule",
              "properties": {
                "ruleType": "Basic",
                "httpListener": {
                  "id": "Microsoft.Network/applicationGateways/httpListeners/GEN-UNIQUE-agw/apim-listener"
                },
                "backendAddressPool": {
                  "id": "Microsoft.Network/applicationGateways/backendAddressPools/GEN-UNIQUE-agw/gatewayBackEnd"
                },
                "backendHttpSettings": {
                  "id": "Microsoft.Network/applicationGateways/backendHttpSettingsCollection/GEN-UNIQUE-agw/apim-gateway-https-setting"
                }
              }
            }
          ],
          "probes": [
            {
              "name": "apim-gateway-probe",
              "properties": {
                "protocol": "Https",
                "host": "GEN-UNIQUE-apim.azure-api.net",
                "port": 443,
                "path": "/status-0123456789abcdef",
                "interval": 30,
                "timeout": 120,
                "unhealthyThreshold": 8,
                "pickHostNameFromBackendHttpSettings": false,
                "minServers": 0
              }
            }
          ],
          "webApplicationFirewallConfiguration": {
            "enabled": true,
            "firewallMode": "Detection",
            "ruleSetType": "OWASP",
            "ruleSetVersion": "3.2",
            "requestBodyCheck": true,
            "maxRequestBodySizeInKb": 128,
            "fileUploadLimitInMb": 100
          }
        }
      },
      {
        "scope": "[format('Microsoft.Network/applicationGateways/{0}', variables('app-gateway-name'))]",
        "type": "Microsoft.Insights/diagnosticSettings",
        "apiVersion": "2017-05-01-preview",
        "name": "logToAnalytics",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "Microsoft.Network/applicationGateways/GEN-UNIQUE-agw"
        ],
        "properties": {
          "workspaceId": "GET-PREREQ-logAnalyticsWorkspaceId",
          "logs": [
            {
              "category": "ApplicationGatewayAccessLog",
              "enabled": true
            },
            {
              "category": "ApplicationGatewayPerformanceLog",
              "enabled": true
            },
            {
              "category": "ApplicationGatewayFirewallLog",
              "enabled": true
            }
          ],
          "metrics": [
            {
              "category": "AllMetrics",
              "enabled": true
            }
          ]
        }
      },
      {
        "type": "Microsoft.Insights/components",
        "apiVersion": "2020-02-02-preview",
        "name": "GEN-UNIQUE-ai",
        "location": "[resourceGroup().location]",
        "kind": "web",
        "properties": {
          "Application_Type": "web",
          "WorkspaceResourceId": "GET-PREREQ-logAnalyticsWorkspaceId"
        }
      },
      {
        "type": "Microsoft.Network/publicIPAddresses",
        "apiVersion": "2020-11-01",
        "name": "GEN-UNIQUE-pip",
        "location": "[resourceGroup().location]",
        "sku": {
          "name": "Standard",
          "tier": "Regional"
        },
        "properties": {
          "publicIPAllocationMethod": "Static",
          "dnsSettings": {
            "domainNameLabel": "GEN-UNIQUE"
          }
        }
      },
      {
        "type": "Microsoft.Network/virtualNetworks",
        "apiVersion": "2020-11-01",
        "name": "GEN-UNIQUE-vnet",
        "location": "[resourceGroup().location]",
        "properties": {
          "addressSpace": {
            "addressPrefixes": [
              "10.0.0.0/16"
            ]
          },
          "subnets": [
            {
              "type": "subnets",
              "name": "appGatewaySubnet",
              "properties": {
                "addressPrefix": "10.0.0.0/24",
                "serviceEndpoints": [
                  {
                    "service": "Microsoft.KeyVault",
                    "locations": [
                      "*"
                    ]
                  }
                ],
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
              }
            },
            {
              "type": "subnets",
              "name": "apimSubnet",
              "properties": {
                "addressPrefix": "10.0.1.0/24",
                "serviceEndpoints": [
                  {
                    "service": "Microsoft.KeyVault",
                    "locations": [
                      "*"
                    ]
                  }
                ],
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
              }
            }
          ]
        }
      },
      {
        "type": "Microsoft.Network/privateDnsZones",
        "apiVersion": "2018-09-01",
        "name": "azure-api.net",
        "location": "global",
        "dependsOn": [
          "Microsoft.ApiManagement/service/GEN-UNIQUE-apim",
          "Microsoft.Network/virtualNetworks/GEN-UNIQUE-vnet"
        ],
        "resources": [
          {
            "condition": true,
            "type": "A",
            "apiVersion": "2018-09-01",
            "name": "GEN-UNIQUE-apim",
            "location": "global",
            "dependsOn": [
              "Microsoft.Network/privateDnsZones/azure-api.net",
              "Microsoft.ApiManagement/service/GEN-UNIQUE-apim"
            ],
            "properties": {
              "ttl": 36000,
              "aRecords": [
                {
                  "ipv4Address": "[reference(resourceId('Microsoft.ApiManagement/service', variables('apim-name'))).privateIPAddresses[0]]"
                }
              ]
            }
          },
          {
            "type": "virtualNetworkLinks",
            "apiVersion": "2020-06-01",
            "name": "GEN-UNIQUE-vnet-dns-link",
            "location": "global",
            "dependsOn": [
              "Microsoft.Network/privateDnsZones/azure-api.net"
            ],
            "properties": {
              "registrationEnabled": true,
              "virtualNetwork": {
                "id": "Microsoft.Network/virtualNetworks/GEN-UNIQUE-vnet"
              }
            }
          }
        ],
        "properties": {}
      }
    ],
    "outputs": {
      "publicEndpointFqdn": {
        "type": "string",
        "value": "[reference(variables('public-ip-name')).dnsSettings.fqdn]"
      }
    },
    "\uff04schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
  }
}