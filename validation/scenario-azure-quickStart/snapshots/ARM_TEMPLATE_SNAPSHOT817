{
  "structure": "filesystem",
  "error": null,
  "reference": "master",
  "contentType": "json",
  "source": "gitConnectorAzureQuickStart",
  "paths": [
    "/demos/storage-spaces-direct/nestedtemplates/deploy-s2d-cluster.json"
  ],
  "timestamp": 1642962901856,
  "queryuser": null,
  "checksum": "99914b932bd37a50b983c5e7c90ae93b",
  "node": {
    "masterSnapshotId": "ARM_TEMPLATE_SNAPSHOT",
    "type": "arm",
    "collection": "armtemplate",
    "paths": [
      "/demos/storage-spaces-direct/nestedtemplates/deploy-s2d-cluster.json"
    ],
    "snapshotId": "ARM_TEMPLATE_SNAPSHOT817",
    "status": "active",
    "validate": true,
    "resourceTypes": [
      "microsoft.resources/deployments",
      "microsoft.network/networkinterfaces",
      "microsoft.compute/virtualmachines/extensions",
      "microsoft.storage/storageaccounts",
      "microsoft.compute/availabilitysets"
    ]
  },
  "snapshotId": "ARM_TEMPLATE_SNAPSHOT817",
  "collection": "armtemplate",
  "json": {
    "contentVersion": "1.0.0.0",
    "parameters": {
      "namePrefix": {
        "type": "string",
        "minLength": 3,
        "maxLength": 8,
        "metadata": {
          "description": "Naming prefix for each new resource created. 3-char min, 8-char max, lowercase alphanumeric"
        }
      },
      "domainName": {
        "type": "string",
        "metadata": {
          "description": "DNS domain name for existing Active Directory domain"
        }
      },
      "adminUsername": {
        "type": "string",
        "metadata": {
          "description": "Name of the Administrator of the existing Active Directory Domain"
        }
      },
      "adminPassword": {
        "type": "securestring",
        "minLength": 12,
        "metadata": {
          "description": "Password for the Administrator account of the existing Active Directory Domain"
        }
      },
      "storageAccountType": {
        "type": "string",
        "allowedValues": [
          "Standard_LRS",
          "Standard_GRS",
          "Standard_RAGRS",
          "Premium_LRS"
        ],
        "metadata": {
          "description": "Type of new Storage Accounts (Standard_LRS, Standard_GRS, Standard_RAGRS or Premium_LRS) to be created to store VM disks"
        }
      },
      "nicSubnetUri": {
        "type": "string",
        "metadata": {
          "description": "Resource ID for existing vnet/subnet to which VM NICs should be attached"
        }
      },
      "vmSize": {
        "type": "string",
        "metadata": {
          "description": "Size of the S2D VMs to be created"
        }
      },
      "vmCount": {
        "type": "int",
        "minValue": 2,
        "maxValue": 3,
        "metadata": {
          "description": "Number of S2D VMs to be created in cluster (Min=2, Max=3)"
        }
      },
      "vmDiskSize": {
        "type": "int",
        "minValue": 128,
        "maxValue": 1023,
        "metadata": {
          "description": "Size of each data disk in GB on each S2D VM (Min=128, Max=1023)"
        }
      },
      "vmDiskCount": {
        "type": "int",
        "minValue": 2,
        "maxValue": 32,
        "metadata": {
          "description": "Number of data disks on each S2D VM (Min=2, Max=32). Ensure that the VM size you've selected will support this number of data disks."
        }
      },
      "sofsName": {
        "type": "string",
        "metadata": {
          "description": "Name of clustered Scale-Out File Server role"
        }
      },
      "shareName": {
        "type": "string",
        "metadata": {
          "description": "Name of shared data folder on clustered Scale-Out File Server role"
        }
      },
      "imagePublisher": {
        "type": "string",
        "defaultValue": "MicrosoftWindowsServer"
      },
      "imageOffer": {
        "type": "string",
        "defaultValue": "WindowsServer"
      },
      "imageSKU": {
        "type": "string",
        "defaultValue": "2019-Datacenter"
      },
      "imageVersion": {
        "type": "string",
        "defaultValue": "latest"
      },
      "_artifactsLocation": {
        "type": "string"
      },
      "_artifactsLocationSasToken": {
        "type": "string"
      },
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "metadata": {
          "description": "Location for all resources."
        }
      }
    },
    "variables": {
      "apiVersionStorage": "2016-01-01",
      "storageNamePrefix": "[concat(parameters('namePrefix'),uniqueString(resourceGroup().id),'vm')]",
      "witnessStorageName": "[concat(parameters('namePrefix'),uniqueString(resourceGroup().id),'cw')]",
      "witnessStorageType": "Standard_LRS",
      "vmNamePrefix": "namePrefix-s2d-",
      "vmAvailabilitySetName": "namePrefix-s2d-as",
      "clusterName": "namePrefix-s2d-c",
      "vmLoopTemplateURL": "_artifactsLocation/nestedtemplates/newVM.json_artifactsLocationSasToken",
      "s2dPrepModulesURL": "_artifactsLocation/dsc/prep-s2d.ps1.zip_artifactsLocationSasToken",
      "s2dPrepFunction": "PrepS2D.ps1\\PrepS2D",
      "s2dConfigModulesURL": "_artifactsLocation/dsc/config-s2d.ps1.zip_artifactsLocationSasToken",
      "s2dConfigFunction": "ConfigS2D.ps1\\ConfigS2D"
    },
    "resources": [
      {
        "type": "Microsoft.Compute/availabilitySets",
        "name": "namePrefix-s2d-as",
        "apiVersion": "2017-03-30",
        "location": "[resourceGroup().location]",
        "properties": {
          "PlatformUpdateDomainCount": 3,
          "PlatformFaultDomainCount": 2
        },
        "sku": {
          "name": "Aligned"
        }
      },
      {
        "type": "Microsoft.Storage/storageAccounts",
        "name": "[variables('witnessStorageName')]",
        "apiVersion": "2016-01-01",
        "location": "[resourceGroup().location]",
        "sku": {
          "name": "Standard_LRS"
        },
        "kind": "Storage"
      },
      {
        "type": "Microsoft.Storage/storageAccounts",
        "name": "[concat(variables('storageNamePrefix'),copyindex())]",
        "apiVersion": "2016-01-01",
        "copy": {
          "name": "storageAccountLoop",
          "count": "vmCount"
        },
        "location": "[resourceGroup().location]",
        "sku": {
          "name": "storageAccountType"
        },
        "kind": "Storage"
      },
      {
        "name": "namePrefix-s2d-copyindex()-nic",
        "type": "Microsoft.Network/networkInterfaces",
        "location": "[resourceGroup().location]",
        "apiVersion": "2015-06-15",
        "copy": {
          "name": "nicLoop",
          "count": "vmCount"
        },
        "properties": {
          "ipConfigurations": [
            {
              "name": "ipconfig1",
              "properties": {
                "privateIPAllocationMethod": "Dynamic",
                "subnet": {
                  "id": "nicSubnetUri"
                }
              }
            }
          ]
        }
      },
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "copy": {
          "name": "virtualMachineLoop",
          "count": "vmCount"
        },
        "name": "namePrefix-s2d-copyindex()-newVM",
        "dependsOn": [
          "storageAccountLoop",
          "nicLoop",
          "Microsoft.Compute/availabilitySets/namePrefix-s2d-as"
        ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "_artifactsLocation/nestedtemplates/newVM.json_artifactsLocationSasToken"
          },
          "parameters": {
            "vmName": {
              "value": "namePrefix-s2d-copyindex()"
            },
            "storageAccountUri": {
              "value": "[reference(concat('Microsoft.Storage/storageAccounts/',variables('StorageNamePrefix'),copyIndex()),variables('apiVersionStorage')).primaryEndpoints.blob]"
            },
            "vmAvailabilitySetName": {
              "value": "namePrefix-s2d-as"
            },
            "vmSize": {
              "value": "vmSize"
            },
            "vmDiskCount": {
              "value": "vmDiskCount"
            },
            "vmDiskSize": {
              "value": "vmDiskSize"
            },
            "adminUsername": {
              "value": "adminUsername"
            },
            "adminPassword": {
              "value": "adminPassword"
            },
            "_artifactsLocation": {
              "value": "_artifactsLocation"
            },
            "_artifactsLocationSasToken": {
              "value": "_artifactsLocationSasToken"
            },
            "imagePublisher": {
              "value": "MicrosoftWindowsServer"
            },
            "imageOffer": {
              "value": "WindowsServer"
            },
            "imageSKU": {
              "value": "2019-Datacenter"
            },
            "imageVersion": {
              "value": "latest"
            }
          }
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "name": "[concat(variables('vmNamePrefix'),copyindex(1),'/s2dPrep')]",
        "apiVersion": "2015-06-15",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "virtualMachineLoop"
        ],
        "copy": {
          "name": "virtualMachineExtensionLoop",
          "count": "[sub(parameters('vmCount'),1)]"
        },
        "properties": {
          "publisher": "Microsoft.Powershell",
          "type": "DSC",
          "typeHandlerVersion": "2.20",
          "autoUpgradeMinorVersion": true,
          "settings": {
            "modulesUrl": "_artifactsLocation/dsc/prep-s2d.ps1.zip_artifactsLocationSasToken",
            "configurationFunction": "PrepS2D.ps1\\PrepS2D",
            "properties": {
              "domainName": "domainName",
              "adminCreds": {
                "userName": "adminUsername",
                "password": "PrivateSettingsRef:adminPassword"
              }
            }
          },
          "protectedSettings": {
            "items": {
              "adminPassword": "adminPassword"
            }
          }
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "name": "namePrefix-s2d-0/s2dConfig",
        "apiVersion": "2015-06-15",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "virtualMachineLoop",
          "virtualMachineExtensionLoop",
          "[resourceId('Microsoft.Storage/storageAccounts', variables('witnessStorageName'))]"
        ],
        "properties": {
          "publisher": "Microsoft.Powershell",
          "type": "DSC",
          "typeHandlerVersion": "2.20",
          "autoUpgradeMinorVersion": true,
          "settings": {
            "modulesUrl": "_artifactsLocation/dsc/config-s2d.ps1.zip_artifactsLocationSasToken",
            "configurationFunction": "ConfigS2D.ps1\\ConfigS2D",
            "properties": {
              "domainName": "domainName",
              "clusterName": "namePrefix-s2d-c",
              "sofsName": "sofsName",
              "shareName": "shareName",
              "vmNamePrefix": "namePrefix-s2d-",
              "vmCount": "vmCount",
              "vmDiskSize": "vmDiskSize",
              "witnessStorageName": "[variables('witnessStorageName')]",
              "witnessStorageEndpoint": "[replace(split(reference(concat('Microsoft.Storage/storageAccounts/', variables('witnessStorageName'))).primaryEndpoints.blob, 'blob.')[1], '/', '')]",
              "witnessStorageKey": {
                "userName": "PLACEHOLDER-DO-NOT-USE",
                "password": "PrivateSettingsRef:witnessStorageKey"
              },
              "adminCreds": {
                "userName": "adminUsername",
                "password": "PrivateSettingsRef:adminPassword"
              }
            }
          },
          "protectedSettings": {
            "items": {
              "adminPassword": "adminPassword",
              "witnessStorageKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts',variables('witnessStorageName')),variables('apiVersionStorage')).keys[0].value]"
            }
          }
        }
      }
    ],
    "outputs": {
      "sofsName": {
        "type": "string",
        "value": "[parameters('sofsName')]"
      },
      "shareName": {
        "type": "string",
        "value": "[parameters('shareName')]"
      }
    },
    "\uff04schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
  }
}