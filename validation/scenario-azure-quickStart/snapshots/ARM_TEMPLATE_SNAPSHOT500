{
  "structure": "filesystem",
  "error": null,
  "reference": "master",
  "contentType": "json",
  "source": "gitConnectorAzureQuickStart",
  "paths": [
    "/application-workloads/sap/sap-lama-apps/azuredeploy.json",
    "/application-workloads/sap/sap-lama-apps/azuredeploy.parameters.json"
  ],
  "timestamp": 1642962896054,
  "queryuser": null,
  "checksum": "99914b932bd37a50b983c5e7c90ae93b",
  "node": {
    "masterSnapshotId": "ARM_TEMPLATE_SNAPSHOT",
    "type": "arm",
    "collection": "armtemplate",
    "paths": [
      "/application-workloads/sap/sap-lama-apps/azuredeploy.json",
      "/application-workloads/sap/sap-lama-apps/azuredeploy.parameters.json"
    ],
    "snapshotId": "ARM_TEMPLATE_SNAPSHOT500",
    "status": "active",
    "validate": true,
    "resourceTypes": [
      "microsoft.network/virtualnetworks",
      "microsoft.resources/deployments",
      "microsoft.network/networkinterfaces",
      "microsoft.compute/virtualmachines/extensions",
      "microsoft.compute/virtualmachines",
      "microsoft.network/networksecuritygroups"
    ]
  },
  "snapshotId": "ARM_TEMPLATE_SNAPSHOT500",
  "collection": "armtemplate",
  "json": {
    "contentVersion": "1.0.0.0",
    "parameters": {
      "sapSystemId": {
        "type": "string",
        "minLength": 3,
        "maxLength": 3,
        "defaultValue": "DEQ",
        "metadata": {
          "description": "SAP System ID."
        }
      },
      "computerName": {
        "type": "string",
        "minLength": 3,
        "defaultValue": "deq-app-0",
        "metadata": {
          "description": "The computer name. This parameter is also used as virtual machine name. It is required if you want to deploy this template using SAP LaMa."
        }
      },
      "osType": {
        "type": "string",
        "allowedValues": [
          "Windows Server 2012 Datacenter",
          "Windows Server 2012 R2 Datacenter",
          "Windows Server 2016 Datacenter",
          "SLES 12",
          "RHEL 7",
          "Oracle Linux 7"
        ],
        "defaultValue": "Windows Server 2016 Datacenter",
        "metadata": {
          "description": "The type of the operating system you want to deploy."
        }
      },
      "dbType": {
        "type": "string",
        "allowedValues": [
          "SQL",
          "OTHER"
        ],
        "defaultValue": "OTHER",
        "metadata": {
          "description": "The type of the database. If you select SQL Server, you can provide the path to the ODBC driver which is then automatically installed."
        }
      },
      "sapSystemSize": {
        "type": "string",
        "allowedValues": [
          "Demo",
          "Small < 2.000 SAPS",
          "Medium < 9.000 SAPS",
          "Large < 18.000 SAPS",
          "X-Large < 40.000 SAPS"
        ],
        "defaultValue": "Small < 2.000 SAPS",
        "metadata": {
          "description": "The size of the SAP System you want to deploy."
        }
      },
      "adminUsername": {
        "type": "string",
        "metadata": {
          "description": "Username for the virtual machine."
        },
        "value": "GEN-UNIQUE"
      },
      "authenticationType": {
        "type": "string",
        "defaultValue": "password",
        "allowedValues": [
          "password",
          "sshPublicKey"
        ],
        "metadata": {
          "description": "Type of authentication to use on the Virtual Machine."
        }
      },
      "adminPasswordOrKey": {
        "type": "securestring",
        "metadata": {
          "description": "Password or ssh key for the Virtual Machine."
        },
        "value": "GEN-PASSWORD"
      },
      "subnetId": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "The id of the subnet you want to use."
        }
      },
      "deployEmptyTarget": {
        "type": "bool",
        "defaultValue": false,
        "metadata": {
          "description": "You can deploy an empty target if you want to use the virtual machine as a target for an instance relocate or similar. In this case, no additional disks or IP configurations are attached."
        }
      },
      "sapArtifactsLocation": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "The location of the SAR archives. The location should contain archives for SAPCAR, SAP Host Agent, SAPACEXT,  Microsoft Visual C++ Redistributable and the Microsoft ODBC driver for SQL Server."
        }
      },
      "sapArtifactsLocationSasToken": {
        "type": "securestring",
        "metadata": {
          "description": "The sasToken required to access sapArtifactsLocation."
        },
        "defaultValue": ""
      },
      "sapcarFilename": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "The filename for the sapcar application that matches the operating system you deploy. sapcar is used to extract the archives you provide in other parameters."
        }
      },
      "sapHostAgentArchiveFilename": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "The filename of the SAP Host Agent archive. SAP Host Agent is deployed as part of this template depoyment."
        }
      },
      "sapacExtArchiveFilename": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "The filename of the SAP Adaptive Extensions. SAP Note 2343511 lists the minimum patch level required for Azure."
        }
      },
      "vcRedistFilename": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "The filename of the VC Runtime that is required to install the SAP Adaptive Extensions. This parameter is only required for Windows."
        }
      },
      "odbcDriverFilename": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "The filename of the ODBC driver you want to install. Only Microsoft ODBC driver for SQL Server is supported."
        }
      },
      "sapadmPassword": {
        "type": "securestring",
        "defaultValue": "",
        "metadata": {
          "description": "The password for the sapadm user."
        }
      },
      "sapadmId": {
        "type": "int",
        "defaultValue": 790,
        "metadata": {
          "description": "The Linux User Id of the sapadm user. Not required for Windows."
        }
      },
      "sapsysGid": {
        "type": "int",
        "defaultValue": 79,
        "metadata": {
          "description": "The Linux group id of the sapsys group. Not required for Windows."
        }
      },
      "availabilityZone": {
        "type": "int",
        "defaultValue": 0,
        "minValue": 0,
        "maxValue": 3,
        "metadata": {
          "description": "Zone number. Set to 0 if you do not want to use Availability Zones"
        }
      },
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "metadata": {
          "description": "Location for all resources"
        }
      },
      "_artifactsLocation": {
        "type": "string",
        "metadata": {
          "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
        },
        "defaultValue": "[deployment().properties.templateLink.uri]"
      },
      "_artifactsLocationSasToken": {
        "type": "securestring",
        "metadata": {
          "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
        },
        "defaultValue": ""
      }
    },
    "variables": {
      "selectedZones": "[if(equals(parameters('availabilityZone'),0), json('null'), array(parameters('availabilityZone')))]",
      "images": {
        "Windows Server 2012 Datacenter": {
          "sku": "2012-Datacenter",
          "offer": "WindowsServer",
          "publisher": "MicrosoftWindowsServer",
          "OSType": "Windows",
          "osDiskSize": 128
        },
        "Windows Server 2012 R2 Datacenter": {
          "sku": "2012-R2-Datacenter",
          "offer": "WindowsServer",
          "publisher": "MicrosoftWindowsServer",
          "OSType": "Windows",
          "osDiskSize": 128
        },
        "Windows Server 2016 Datacenter": {
          "sku": "2016-Datacenter",
          "offer": "WindowsServer",
          "publisher": "MicrosoftWindowsServer",
          "OSType": "Windows",
          "osDiskSize": 128
        },
        "SLES 12": {
          "sku": "12-SP3",
          "offer": "SLES-SAP",
          "publisher": "SUSE",
          "OSType": "Linux",
          "osDiskSize": 128
        },
        "RHEL 7": {
          "sku": "7.3",
          "offer": "RHEL",
          "publisher": "RedHat",
          "OSType": "Linux",
          "osDiskSize": 128
        },
        "Oracle Linux 7": {
          "sku": "7.3",
          "offer": "Oracle-Linux",
          "publisher": "Oracle",
          "OSType": "Linux",
          "osDiskSize": 128
        }
      },
      "internalOSType": "(images)[parameters(osType)].OSType",
      "linuxConfiguration": {
        "disablePasswordAuthentication": true,
        "ssh": {
          "publicKeys": [
            {
              "path": "/home/GEN-UNIQUE/.ssh/authorized_keys",
              "keyData": "GEN-PASSWORD"
            }
          ]
        }
      },
      "osConfigs": {
        "Windows": {
          "Publisher": "Microsoft.Compute",
          "Name": "CustomScriptExtension",
          "Version": "1.7",
          "script": "[uri(parameters('_artifactsLocation'), concat('scripts/diskConfig.ps1', parameters('_artifactsLocationSasToken')))]",
          "scriptCall": "powershell.exe -ExecutionPolicy bypass -File scripts/diskConfig.ps1",
          "disks": [
            {
              "lun": 0,
              "name": "deq-app-0-[toLower(parameters('sapSystemId'))]-apps",
              "caching": "ReadOnly",
              "createOption": "Empty",
              "diskSizeGB": 128
            }
          ],
          "scriptArguments": "-luns \"0\" -names \"sap\" -paths \"C:\\usr\\sap\\DEQ\"  -sizes \"100\""
        },
        "Linux": {
          "Publisher": "Microsoft.Azure.Extensions",
          "Name": "CustomScript",
          "Version": "2.0",
          "script": "[uri(parameters('_artifactsLocation'), concat('scripts/diskConfig.sh', parameters('_artifactsLocationSasToken')))]",
          "scriptCall": "sh diskConfig.sh"
        }
      },
      "cseExtPublisher": "(osConfigs)[variables(internalOSType)].Publisher",
      "cseExtName": "(osConfigs)[variables(internalOSType)].Name",
      "cseExtVersion": "(osConfigs)[variables(internalOSType)].Version",
      "csExtensionScript": "(osConfigs)[variables(internalOSType)].script",
      "csExtensionscriptCall": "(osConfigs)[variables(internalOSType)].scriptCall",
      "sizes": {
        "Demo": {
          "Linux": {
            "vmSize": "Standard_E2s_v3",
            "useFastNetwork": false
          },
          "Windows": {
            "vmSize": "Standard_E2s_v3",
            "useFastNetwork": false
          }
        },
        "Small < 2.000 SAPS": {
          "Linux": {
            "vmSize": "Standard_E2s_v3",
            "useFastNetwork": false
          },
          "Windows": {
            "vmSize": "Standard_E2s_v3",
            "useFastNetwork": false
          }
        },
        "Medium < 9.000 SAPS": {
          "Linux": {
            "vmSize": "Standard_E2s_v3",
            "useFastNetwork": false
          },
          "Windows": {
            "vmSize": "Standard_E2s_v3",
            "useFastNetwork": false
          }
        },
        "Large < 18.000 SAPS": {
          "Linux": {
            "vmSize": "Standard_E4s_v3",
            "useFastNetwork": true
          },
          "Windows": {
            "vmSize": "Standard_E4s_v3",
            "useFastNetwork": true
          }
        },
        "X-Large < 40.000 SAPS": {
          "Linux": {
            "vmSize": "Standard_E4s_v3",
            "useFastNetwork": true
          },
          "Windows": {
            "vmSize": "Standard_E4s_v3",
            "useFastNetwork": true
          }
        }
      },
      "vmName": "deq-app-0",
      "nicName": "deq-app-0-nic",
      "sidlower": "[toLower(parameters('sapSystemId'))]",
      "vnetName": "[toLower(parameters('sapSystemId'))]-vnet",
      "nsgName": "[toLower(parameters('sapSystemId'))]-nsg",
      "subnetName": "Subnet",
      "subnets": {
        "true": "Microsoft.Network/virtualNetworks/subnets/[toLower(parameters('sapSystemId'))]-vnet/Subnet",
        "false": ""
      },
      "selectedSubnetId": "(subnets)[string(equals(length(parameters(subnetId)), 0))]",
      "basicIPConfig": [
        {
          "name": "ipconfig-vm",
          "properties": {
            "privateIPAllocationMethod": "Dynamic",
            "subnet": {
              "id": "(subnets)[string(equals(length(parameters(subnetId)), 0))]"
            },
            "primary": true
          }
        }
      ],
      "databaseIPConfig": {
        "Linux": [
          {
            "name": "ipconfig-di",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "subnet": {
                "id": "(subnets)[string(equals(length(parameters(subnetId)), 0))]"
              },
              "primary": false
            }
          }
        ],
        "Windows": [
          {
            "name": "ipconfig-di",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "subnet": {
                "id": "(subnets)[string(equals(length(parameters(subnetId)), 0))]"
              },
              "primary": false
            }
          }
        ]
      },
      "selectedIPConfig": "[concat(variables('basicIPConfig'), if(parameters('deployEmptyTarget'), json('[]'), variables('databaseIPConfig')[variables('internalOSType')]))]",
      "osSecurityRules": {
        "Windows": [
          {
            "name": "RDP",
            "properties": {
              "description": "Allow RDP Subnet",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "3389",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          }
        ],
        "Linux": [
          {
            "name": "SSH",
            "properties": {
              "description": "Allow SSH Subnet",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          }
        ]
      },
      "selectedSecurityRules": "(osSecurityRules)[variables(internalOSType)]"
    },
    "resources": [
      {
        "type": "Microsoft.Network/networkSecurityGroups",
        "name": "[toLower(parameters('sapSystemId'))]-nsg",
        "apiVersion": "2020-07-01",
        "location": "[resourceGroup().location]",
        "condition": false,
        "properties": {
          "securityRules": "(osSecurityRules)[variables(internalOSType)]"
        }
      },
      {
        "type": "Microsoft.Network/virtualNetworks",
        "name": "[toLower(parameters('sapSystemId'))]-vnet",
        "apiVersion": "2018-04-01",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "Microsoft.Network/networkSecurityGroups//[toLower(parameters('sapSystemId'))]-nsg"
        ],
        "condition": false,
        "properties": {
          "addressSpace": {
            "addressPrefixes": [
              "10.0.0.0/16"
            ]
          },
          "subnets": [
            {
              "name": "Subnet",
              "properties": {
                "addressPrefix": "10.0.0.0/24",
                "networkSecurityGroup": {
                  "id": "Microsoft.Network/networkSecurityGroups/[toLower(parameters('sapSystemId'))]-nsg"
                }
              }
            }
          ]
        }
      },
      {
        "type": "Microsoft.Network/networkInterfaces",
        "name": "deq-app-0-nic",
        "apiVersion": "2017-06-01",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "Microsoft.Network/virtualNetworks//[toLower(parameters('sapSystemId'))]-vnet"
        ],
        "properties": {
          "ipConfigurations": "[concat(variables('basicIPConfig'), if(parameters('deployEmptyTarget'), json('[]'), variables('databaseIPConfig')[variables('internalOSType')]))]",
          "enableAcceleratedNetworking": "(sizes)[parameters(sapSystemSize)][variables(internalOSType)].useFastNetwork"
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines",
        "name": "deq-app-0",
        "dependsOn": [
          "Microsoft.Network/networkInterfaces//deq-app-0-nic"
        ],
        "zones": "[if(equals(parameters('availabilityZone'),0), json('null'), array(parameters('availabilityZone')))]",
        "apiVersion": "2017-12-01",
        "location": "[resourceGroup().location]",
        "properties": {
          "hardwareProfile": {
            "vmSize": "(sizes)[parameters(sapSystemSize)][variables(internalOSType)].vmSize"
          },
          "osProfile": {
            "computerName": "deq-app-0",
            "adminUsername": "GEN-UNIQUE",
            "adminPassword": "GEN-PASSWORD",
            "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), json('null'), variables('linuxConfiguration'))]"
          },
          "storageProfile": {
            "imageReference": {
              "publisher": "(images)[parameters(osType)].publisher",
              "offer": "(images)[parameters(osType)].offer",
              "sku": "(images)[parameters(osType)].sku",
              "version": "latest"
            },
            "osDisk": {
              "name": "deq-app-0-osdisk",
              "caching": "ReadWrite",
              "createOption": "FromImage",
              "diskSizeGB": "(images)[parameters(osType)].osDiskSize",
              "managedDisk": {
                "storageAccountType": "Premium_LRS"
              }
            },
            "dataDisks": "[if(parameters('deployEmptyTarget'), json('[]'), variables('osConfigs')[variables('internalOSType')].disks)]"
          },
          "networkProfile": {
            "networkInterfaces": [
              {
                "id": "Microsoft.Network/networkInterfaces/deq-app-0-nic"
              }
            ]
          }
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "name": "deq-app-0/(osConfigs)[variables(internalOSType)].Name",
        "apiVersion": "2017-12-01",
        "location": "[resourceGroup().location]",
        "condition": "[and( not(parameters('deployEmptyTarget')), equals(variables('internalOSType'), 'Windows'))]",
        "dependsOn": [
          "Microsoft.Compute/virtualMachines//deq-app-0"
        ],
        "properties": {
          "publisher": "(osConfigs)[variables(internalOSType)].Publisher",
          "type": "(osConfigs)[variables(internalOSType)].Name",
          "typeHandlerVersion": "(osConfigs)[variables(internalOSType)].Version",
          "autoUpgradeMinorVersion": true,
          "settings": {
            "fileUris": [
              "(osConfigs)[variables(internalOSType)].script"
            ]
          },
          "protectedSettings": {
            "commandToExecute": "[concat(variables('csExtensionscriptCall'), ' ', variables('osConfigs')[variables('internalOSType')].scriptArguments)]"
          }
        }
      },
      {
        "apiVersion": "2018-02-01",
        "name": "[concat(deployment().name, '-odbc')]",
        "type": "Microsoft.Resources/deployments",
        "condition": false,
        "dependsOn": [
          "Microsoft.Compute/virtualMachines/extensions/deq-app-0/(osConfigs)[variables(internalOSType)].Name"
        ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/runCommand.json', parameters('_artifactsLocationSasToken')))]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "vmName": {
              "value": "deq-app-0"
            },
            "command": {
              "value": "%SystemRoot%\\System32\\msiexec.exe /i msodbcsql.msi /quiet /norestart /log c:\\windows\\sql4sap.msi.log IACCEPTMSODBCSQLLICENSETERMS=YES MSIRESTARTMANAGERCONTROL=Disable"
            },
            "files": {
              "value": [
                "[uri(parameters('sapArtifactsLocation'), concat(parameters('odbcDriverFilename'), parameters('sapArtifactsLocationSasToken')))]"
              ]
            },
            "osType": {
              "value": "(images)[parameters(osType)].OSType"
            },
            "location": {
              "value": "[resourceGroup().location]"
            }
          }
        }
      },
      {
        "apiVersion": "2018-02-01",
        "name": "[concat(deployment().name, '-installsaphostagent')]",
        "type": "Microsoft.Resources/deployments",
        "condition": "[greater(length(parameters('sapHostAgentArchiveFilename')), 0)]",
        "dependsOn": [
          "[resourceId('Microsoft.Resources/deployments/', concat(deployment().name, '-odbc'))]"
        ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[uri(parameters('_artifactsLocation'), concat('nestedtemplates/installHostAgent.json', parameters('_artifactsLocationSasToken')))]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "vmName": {
              "value": "deq-app-0"
            },
            "cseExtName": {
              "value": "(osConfigs)[variables(internalOSType)].Name"
            },
            "cseExtPublisher": {
              "value": "(osConfigs)[variables(internalOSType)].Publisher"
            },
            "cseExtVersion": {
              "value": "(osConfigs)[variables(internalOSType)].Version"
            },
            "sapArtifactsLocation": {
              "value": ""
            },
            "sapArtifactsLocationSasToken": {
              "value": ""
            },
            "sapcarFilename": {
              "value": ""
            },
            "sapHostAgentArchiveFilename": {
              "value": ""
            },
            "sapacExtArchiveFilename": {
              "value": ""
            },
            "vcRedistFilename": {
              "value": ""
            },
            "sapadmPassword": {
              "value": ""
            },
            "sapadmId": {
              "value": 790
            },
            "sapsysGid": {
              "value": 79
            },
            "osType": {
              "value": "(images)[parameters(osType)].OSType"
            },
            "location": {
              "value": "[resourceGroup().location]"
            }
          }
        }
      }
    ],
    "\uff04schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
  }
}